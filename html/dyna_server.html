<html>
<head>
<title>~/dynadns/dyna_server.html</title>
<meta name="Generator" content="Vim/6.0">
</head>
<body bgcolor="#ffffff" text="#000000">
<pre>
<font color="#a020f0">#!/usr/bin/perl -Tw</font>
<font color="#0000ff">#</font>
<font color="#0000ff">## $Id$</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># This program is Open Source software. It may be distributed under the</font>
<font color="#0000ff"># terms of the GNU General Public License:</font>
<font color="#0000ff">#                               http://www.gnu.org/copyleft/gpl.html</font>
<font color="#0000ff">#</font>
<font color="#0000ff">## Report bugs to &lt;flori@ping.de&gt;.</font>
<font color="#0000ff">#</font>

<font color="#a52a2a"><b>use strict</b></font>;
<font color="#a52a2a"><b>use </b></font>Digest::SHA1 <font color="#ff00ff">qw(</font><font color="#ff00ff">sha1_hex</font><font color="#ff00ff">)</font>;
<font color="#a52a2a"><b>use </b></font>Digest::MD5 <font color="#ff00ff">qw(</font><font color="#ff00ff">md5_hex</font><font color="#ff00ff">)</font>;
<font color="#a52a2a"><b>use </b></font>File::Basename;
<font color="#a52a2a"><b>use </b></font>Cwd;
<font color="#a52a2a"><b>use </b></font>Fcntl <font color="#ff00ff">qw(</font><font color="#ff00ff">:flock</font><font color="#ff00ff">)</font>;
<font color="#a52a2a"><b>use </b></font>Ping::Config <font color="#ff00ff">qw(</font><font color="#ff00ff">$domain</font><font color="#ff00ff">)</font>;
<font color="#a52a2a"><b>use </b></font>Ping::Admdb::Simple;
<font color="#a52a2a"><b>use </b></font>constant <font color="#ff00ff">DEBUG </font>=&gt; <font color="#ff00ff">0</font>;

<font color="#a52a2a"><b>sub</b></font><font color="#008b8b"> </font><font color="#008b8b">update_data</font><font color="#008b8b">($$)</font>;
<font color="#a52a2a"><b>sub</b></font><font color="#008b8b"> </font><font color="#008b8b">to_delete</font><font color="#008b8b">($)</font>;
<font color="#a52a2a"><b>sub</b></font><font color="#008b8b"> </font><font color="#008b8b">is_ipad</font><font color="#008b8b">($)</font>;
<font color="#a52a2a"><b>sub</b></font><font color="#008b8b"> </font><font color="#008b8b">in</font>;
<font color="#a52a2a"><b>sub</b></font><font color="#008b8b"> </font><font color="#008b8b">out</font><font color="#008b8b">($)</font>;
<font color="#a52a2a"><b>sub</b></font><font color="#008b8b"> </font><font color="#008b8b">bake_cookie</font><font color="#008b8b">(@)</font>;
<font color="#a52a2a"><b>sub</b></font><font color="#008b8b"> </font><font color="#008b8b">make_challenge</font><font color="#008b8b">($)</font>;
<font color="#a52a2a"><b>sub</b></font><font color="#008b8b"> </font><font color="#008b8b">make_response_template</font><font color="#008b8b">($)</font>;
<font color="#a52a2a"><b>sub</b></font><font color="#008b8b"> </font><font color="#008b8b">get_password</font><font color="#008b8b">($)</font>;
<font color="#a52a2a"><b>sub</b></font><font color="#008b8b"> </font><font color="#008b8b">validate_response</font><font color="#008b8b">($$)</font>;
<font color="#a52a2a"><b>sub</b></font><font color="#008b8b"> </font><font color="#008b8b">iso_datetime</font>;
<font color="#a52a2a"><b>sub</b></font><font color="#008b8b"> </font><font color="#008b8b">dbg</font><font color="#008b8b">(@)</font>;
<font color="#a52a2a"><b>sub</b></font><font color="#008b8b"> </font><font color="#008b8b">die_callback</font>;

<font color="#008b8b">$ENV</font>{PATH} = <font color="#ff00ff">&quot;</font><font color="#ff00ff">/bin:/usr/bin:/usr/sbin</font><font color="#ff00ff">&quot;</font>;
<font color="#a52a2a"><b>delete</b></font> <font color="#008b8b">@ENV</font>{ <font color="#ff00ff">qw(</font><font color="#ff00ff">IFS CDPATH ENV BASH_ENV</font><font color="#ff00ff">)</font> };
<font color="#008b8b">$SIG</font>{__DIE__} = <font color="#008b8b">\&amp;die_callback</font>;

<font color="#008b8b">$|</font> = <font color="#ff00ff">1</font>;

<font color="#a52a2a"><b>my</b></font> (<font color="#008b8b">$TINYDNS_ROOT</font>)  = <font color="#008b8b">$ENV</font>{ROOT} =~<font color="#a52a2a"><b> /</b></font><font color="#6a5acd">(.+)</font><font color="#a52a2a"><b>/</b></font>;
<font color="#a52a2a"><b>die</b></font> <font color="#ff00ff">&quot;</font><font color="#ff00ff">Need ROOT variable in environment to find tinydns root directory!</font><font color="#ff00ff">&quot;</font>
    <font color="#a52a2a"><b>unless</b></font> <font color="#a52a2a"><b>defined</b></font> <font color="#008b8b">$TINYDNS_ROOT</font>;
<font color="#a52a2a"><b>my</b></font> <font color="#008b8b">%PATH</font> = (
    <font color="#ff00ff">make        </font>=&gt; <font color="#ff00ff">&quot;</font><font color="#ff00ff">/usr/bin/make</font><font color="#ff00ff">&quot;</font>,
    <font color="#ff00ff">data        </font>=&gt; <font color="#ff00ff">&quot;</font><font color="#008b8b">$TINYDNS_ROOT</font><font color="#ff00ff">/data</font><font color="#ff00ff">&quot;</font>,
    <font color="#a52a2a"><b>lock</b></font>        =&gt; <font color="#ff00ff">&quot;</font><font color="#008b8b">$TINYDNS_ROOT</font><font color="#ff00ff">/lock</font><font color="#ff00ff">&quot;</font>,
           );
<font color="#a52a2a"><b>my</b></font> <font color="#008b8b">$CHALLENGE_TYPE</font>  = <font color="#ff00ff">'</font><font color="#ff00ff">sha1</font><font color="#ff00ff">'</font>;
<font color="#a52a2a"><b>my</b></font> <font color="#008b8b">$DYN_DOMAIN</font>      = <font color="#ff00ff">&quot;</font><font color="#ff00ff">dyna.</font><font color="#008b8b">$domain</font><font color="#ff00ff">&quot;</font>;
<font color="#a52a2a"><b>my</b></font> <font color="#008b8b">$DNS_TTL</font>         = <font color="#ff00ff">60</font>;
<font color="#a52a2a"><b>my</b></font> <font color="#008b8b">$DATA_HEADER</font> = <font color="#ff00ff">&lt;&lt;&quot;__DATA_HEADER&quot;</font><font color="#ff00ff">;</font>
<font color="#ff00ff">.</font><font color="#008b8b">$DYN_DOMAIN</font><font color="#ff00ff">:62.72.90.9:a:259200</font>
<font color="#ff00ff">'a.ns.</font><font color="#008b8b">$DYN_DOMAIN</font><font color="#ff00ff">:Powered by djbdns - http</font><font color="#6a5acd">\072</font><font color="#ff00ff">//cr.yp.to/djbdns.html</font>
<font color="#ff00ff">__DATA_HEADER</font>
<font color="#0000ff"># '</font>

{
    <font color="#a52a2a"><b>my</b></font> <font color="#008b8b">$c_cookie</font> = bake_cookie(<font color="#008b8b">$CHALLENGE_TYPE</font>, <font color="#008b8b">$^T</font>, <font color="#008b8b">$$</font>, <font color="#a52a2a"><b>rand</b></font>)
        <font color="#a52a2a"><b>or</b></font> <font color="#a52a2a"><b>die</b></font> <font color="#ff00ff">&quot;</font><font color="#ff00ff">Couldn't bake cookie!</font><font color="#ff00ff">&quot;</font>;
    out(make_challenge(<font color="#008b8b">$c_cookie</font>));

    <font color="#a52a2a"><b>my</b></font> <font color="#008b8b">$line</font> = in;
    <font color="#a52a2a"><b>my</b></font> (<font color="#008b8b">$valid</font>, <font color="#008b8b">$site</font>, <font color="#008b8b">$ipad</font>) = validate_response(<font color="#008b8b">$line</font>, <font color="#008b8b">$c_cookie</font>);
    <font color="#a52a2a"><b>if</b></font> (<font color="#008b8b">$valid</font>) {
        <font color="#008b8b">$ipad</font> <font color="#a52a2a"><b>eq</b></font> <font color="#ff00ff">&quot;</font><font color="#ff00ff">local</font><font color="#ff00ff">&quot;</font> <font color="#a52a2a"><b>and</b></font> <font color="#008b8b">$ipad</font> = <font color="#008b8b">$ENV</font>{TCPREMOTEIP};
        update_data(<font color="#008b8b">$site</font>, <font color="#008b8b">$ipad</font>);
        out(<font color="#ff00ff">&quot;</font><font color="#ff00ff">ACK</font><font color="#ff00ff">&quot;</font>);
        <font color="#a52a2a"><b>warn</b></font> dbg(<font color="#ff00ff">&quot;</font><font color="#008b8b">$site</font><font color="#ff00ff">.</font><font color="#008b8b">$DYN_DOMAIN</font><font color="#ff00ff"> </font><font color="#ff00ff">&quot;</font>,
            to_delete(<font color="#008b8b">$ipad</font>) ? <font color="#ff00ff">&quot;</font><font color="#ff00ff">zapping</font><font color="#ff00ff">&quot;</font> : <font color="#ff00ff">&quot;</font><font color="#ff00ff">-&gt; </font><font color="#008b8b">$ipad</font><font color="#ff00ff">&quot;</font>, <font color="#ff00ff">&quot;</font><font color="#ff00ff">: ok.</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>);
    } <font color="#a52a2a"><b>else</b></font> {
        out(<font color="#ff00ff">&quot;</font><font color="#ff00ff">NAK</font><font color="#ff00ff">&quot;</font>);
        <font color="#a52a2a"><b>warn</b></font> dbg(<font color="#ff00ff">&quot;</font><font color="#008b8b">$site</font><font color="#ff00ff">.</font><font color="#008b8b">$DYN_DOMAIN</font><font color="#ff00ff"> </font><font color="#ff00ff">&quot;</font>,
            to_delete(<font color="#008b8b">$ipad</font>) ? <font color="#ff00ff">&quot;</font><font color="#ff00ff">zapping</font><font color="#ff00ff">&quot;</font> : <font color="#ff00ff">&quot;</font><font color="#ff00ff">-&gt; </font><font color="#008b8b">$ipad</font><font color="#ff00ff">&quot;</font>, <font color="#ff00ff">&quot;</font><font color="#ff00ff">: denied!</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>);
    }
}

<font color="#a52a2a"><b>exit</b></font> <font color="#ff00ff">0</font>;

<font color="#a52a2a"><b>sub</b></font><font color="#008b8b"> </font><font color="#008b8b">update_data</font><font color="#008b8b">($$)</font><font color="#008b8b"> </font>{
    <font color="#a52a2a"><b>my</b></font> <font color="#008b8b">$site</font> = <font color="#a52a2a"><b>shift</b></font>;
    <font color="#a52a2a"><b>my</b></font> <font color="#008b8b">$ipad</font> = <font color="#a52a2a"><b>shift</b></font>;

    <font color="#a52a2a"><b>return</b></font> <font color="#a52a2a"><b>unless</b></font> is_ipad(<font color="#008b8b">$ipad</font>);
    <font color="#a52a2a"><b>chdir</b></font> dirname(<font color="#008b8b">$PATH</font>{data})
        <font color="#a52a2a"><b>or</b></font> <font color="#a52a2a"><b>die</b></font> <font color="#ff00ff">&quot;</font><font color="#ff00ff">Couldn't chdir '</font><font color="#008b8b">$PATH</font><font color="#ff00ff">{data}': </font><font color="#008b8b">$!</font><font color="#ff00ff">&quot;</font>;
    <font color="#a52a2a"><b>local</b></font> (*LOCK, *DATA, *NEW);
    <font color="#a52a2a"><b>open</b></font> <font color="#008b8b">LOCK</font>, <font color="#ff00ff">&quot;</font><font color="#ff00ff">&gt;</font><font color="#008b8b">$PATH</font><font color="#ff00ff">{lock}</font><font color="#ff00ff">&quot;</font> <font color="#a52a2a"><b>or</b></font> <font color="#a52a2a"><b>die</b></font> <font color="#ff00ff">&quot;</font><font color="#ff00ff">Couldn't open '</font><font color="#008b8b">$PATH</font><font color="#ff00ff">{lock}' to write: </font><font color="#008b8b">$!</font><font color="#ff00ff">&quot;</font>;
    <font color="#a52a2a"><b>flock</b></font> <font color="#008b8b">LOCK</font>, LOCK_EX <font color="#a52a2a"><b>or</b></font> <font color="#a52a2a"><b>die</b></font> <font color="#ff00ff">&quot;</font><font color="#ff00ff">Couldn't flock '</font><font color="#008b8b">$PATH</font><font color="#ff00ff">{lock}', LOCK_EX: </font><font color="#008b8b">$!</font><font color="#ff00ff">&quot;</font>;
    <font color="#a52a2a"><b>open</b></font> <font color="#008b8b">DATA</font>, <font color="#ff00ff">&quot;</font><font color="#ff00ff">&lt;</font><font color="#008b8b">$PATH</font><font color="#ff00ff">{data}</font><font color="#ff00ff">&quot;</font>
        <font color="#a52a2a"><b>or</b></font> <font color="#a52a2a"><b>die</b></font> <font color="#ff00ff">&quot;</font><font color="#ff00ff">Couldn't open '</font><font color="#008b8b">$PATH</font><font color="#ff00ff">{data}' to read: </font><font color="#008b8b">$!</font><font color="#ff00ff">&quot;</font>;
    <font color="#a52a2a"><b>open</b></font> <font color="#008b8b">NEW</font>, <font color="#ff00ff">&quot;</font><font color="#ff00ff">&gt;</font><font color="#008b8b">$PATH</font><font color="#ff00ff">{data}.new</font><font color="#ff00ff">&quot;</font>
        <font color="#a52a2a"><b>or</b></font> <font color="#a52a2a"><b>die</b></font> <font color="#ff00ff">&quot;</font><font color="#ff00ff">Couldn't open '</font><font color="#008b8b">$PATH</font><font color="#ff00ff">{data}.new' to write: </font><font color="#008b8b">$!</font><font color="#ff00ff">&quot;</font>;
    <font color="#a52a2a"><b>print</b></font> <font color="#008b8b">NEW</font> <font color="#008b8b">$DATA_HEADER</font>;
    <font color="#a52a2a"><b>my</b></font> <font color="#008b8b">$updated</font> = <font color="#ff00ff">0</font>;
    <font color="#a52a2a"><b>while</b></font> (<font color="#008b8b">&lt;DATA&gt;</font>) {
        <font color="#a52a2a"><b>/</b></font><font color="#ff00ff">^</font><font color="#6a5acd">[.']</font><font color="#a52a2a"><b>/</b></font> <font color="#a52a2a"><b>and</b></font> <font color="#a52a2a"><b>next</b></font>;   <font color="#0000ff"># This has to be in $DATA_HEADER</font>
        <font color="#a52a2a"><b>/</b></font><font color="#ff00ff">^=</font><font color="#008b8b">$site</font><font color="#6a5acd">\.</font><font color="#008b8b">$DYN_DOMAIN</font><font color="#ff00ff">:</font><font color="#a52a2a"><b>/</b></font> <font color="#a52a2a"><b>and</b></font> <font color="#a52a2a"><b>do</b></font> {
            <font color="#008b8b">$updated</font>++ <font color="#a52a2a"><b>and</b></font> <font color="#a52a2a"><b>next</b></font>;
            <font color="#a52a2a"><b>next</b></font> <font color="#a52a2a"><b>if</b></font> to_delete(<font color="#008b8b">$ipad</font>);
            <font color="#a52a2a"><b>print</b></font> <font color="#008b8b">NEW</font> <font color="#ff00ff">&quot;</font><font color="#ff00ff">=</font><font color="#008b8b">$site</font><font color="#ff00ff">.</font><font color="#008b8b">$DYN_DOMAIN</font><font color="#ff00ff">:</font><font color="#008b8b">$ipad</font><font color="#ff00ff">:</font><font color="#008b8b">$DNS_TTL</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>;
            <font color="#a52a2a"><b>next</b></font>;
        };
        <font color="#a52a2a"><b>print</b></font> <font color="#008b8b">NEW</font> <font color="#008b8b">$_</font>;
    }
    <font color="#a52a2a"><b>print</b></font> <font color="#008b8b">NEW</font> <font color="#ff00ff">&quot;</font><font color="#ff00ff">=</font><font color="#008b8b">$site</font><font color="#ff00ff">.</font><font color="#008b8b">$DYN_DOMAIN</font><font color="#ff00ff">:</font><font color="#008b8b">$ipad</font><font color="#ff00ff">:</font><font color="#008b8b">$DNS_TTL</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>
        <font color="#a52a2a"><b>unless</b></font> <font color="#008b8b">$updated</font> <font color="#a52a2a"><b>or</b></font> to_delete(<font color="#008b8b">$ipad</font>);
    <font color="#a52a2a"><b>close</b></font> <font color="#008b8b">NEW</font>;
    <font color="#a52a2a"><b>close</b></font> <font color="#008b8b">DATA</font>;
    <font color="#a52a2a"><b>rename</b></font> <font color="#008b8b">$PATH</font>{data} =&gt; <font color="#ff00ff">&quot;</font><font color="#008b8b">$PATH</font><font color="#ff00ff">{data}.old</font><font color="#ff00ff">&quot;</font>
        <font color="#a52a2a"><b>or</b></font> <font color="#a52a2a"><b>die</b></font> <font color="#ff00ff">&quot;</font><font color="#ff00ff">Couldn't rename '</font><font color="#008b8b">$PATH</font><font color="#ff00ff">{data}' =&gt; '</font><font color="#008b8b">$PATH</font><font color="#ff00ff">{data}.old': </font><font color="#008b8b">$!</font><font color="#ff00ff">&quot;</font>;
    <font color="#a52a2a"><b>rename</b></font> <font color="#ff00ff">&quot;</font><font color="#008b8b">$PATH</font><font color="#ff00ff">{data}.new</font><font color="#ff00ff">&quot;</font> =&gt; <font color="#008b8b">$PATH</font>{data}
        <font color="#a52a2a"><b>or</b></font> <font color="#a52a2a"><b>die</b></font> <font color="#ff00ff">&quot;</font><font color="#ff00ff">Couldn't rename '</font><font color="#008b8b">$PATH</font><font color="#ff00ff">{data}.new' =&gt; '</font><font color="#008b8b">$PATH</font><font color="#ff00ff">{data}': </font><font color="#008b8b">$!</font><font color="#ff00ff">&quot;</font>;
    <font color="#a52a2a"><b>system</b></font> <font color="#ff00ff">&quot;</font><font color="#008b8b">$PATH</font><font color="#ff00ff">{make} &gt;/dev/null 2&gt;&amp;1</font><font color="#ff00ff">&quot;</font>
        <font color="#a52a2a"><b>and</b></font> <font color="#a52a2a"><b>die</b></font> <font color="#ff00ff">&quot;</font><font color="#ff00ff">Couldn't </font><font color="#008b8b">$PATH</font><font color="#ff00ff">{make} new dns data: </font><font color="#008b8b">$?</font><font color="#ff00ff">&quot;</font>;
    <font color="#a52a2a"><b>flock</b></font> <font color="#008b8b">LOCK</font>, LOCK_UN <font color="#a52a2a"><b>or</b></font> <font color="#a52a2a"><b>die</b></font> <font color="#ff00ff">&quot;</font><font color="#ff00ff">Couldn't flock '</font><font color="#008b8b">$PATH</font><font color="#ff00ff">{lock}', LOCK_UN: </font><font color="#008b8b">$!</font><font color="#ff00ff">&quot;</font>;
    <font color="#a52a2a"><b>close</b></font> <font color="#008b8b">LOCK</font>;
    <font color="#a52a2a"><b>return</b></font> <font color="#ff00ff">1</font>;
}

<font color="#a52a2a"><b>sub</b></font><font color="#008b8b"> </font><font color="#008b8b">to_delete</font><font color="#008b8b">($)</font><font color="#008b8b"> </font>{
    <font color="#a52a2a"><b>my</b></font> <font color="#008b8b">$ipad</font> = <font color="#a52a2a"><b>shift</b></font>;

    <font color="#a52a2a"><b>return</b></font> <font color="#008b8b">$ipad</font> =~<font color="#a52a2a"><b> /</b></font><font color="#ff00ff">^0</font><font color="#6a5acd">+</font><font color="#6a5acd">\.</font><font color="#ff00ff">0</font><font color="#6a5acd">+</font><font color="#6a5acd">\.</font><font color="#ff00ff">0</font><font color="#6a5acd">+</font><font color="#6a5acd">\.</font><font color="#ff00ff">0</font><font color="#6a5acd">+</font><font color="#ff00ff">$</font><font color="#a52a2a"><b>/</b></font>;
}

<font color="#a52a2a"><b>sub</b></font><font color="#008b8b"> </font><font color="#008b8b">is_ipad</font><font color="#008b8b">($)</font><font color="#008b8b"> </font>{
        <font color="#a52a2a"><b>my</b></font> <font color="#008b8b">$ipad</font> = <font color="#a52a2a"><b>shift</b></font>;

        <font color="#a52a2a"><b>my</b></font> <font color="#008b8b">@i</font> = <font color="#008b8b">$ipad</font> =~<font color="#a52a2a"><b> /</b></font><font color="#ff00ff">^</font><font color="#6a5acd">(</font><font color="#6a5acd">\d</font><font color="#6a5acd">+)</font><font color="#6a5acd">\.</font><font color="#6a5acd">(</font><font color="#6a5acd">\d</font><font color="#6a5acd">+)</font><font color="#6a5acd">\.</font><font color="#6a5acd">(</font><font color="#6a5acd">\d</font><font color="#6a5acd">+)</font><font color="#6a5acd">\.</font><font color="#6a5acd">(</font><font color="#6a5acd">\d</font><font color="#6a5acd">+)</font><font color="#ff00ff">$</font><font color="#a52a2a"><b>/</b></font> <font color="#a52a2a"><b>or</b></font> <font color="#a52a2a"><b>return</b></font>;
        <font color="#008b8b">$_</font> &gt; <font color="#ff00ff">255</font> <font color="#a52a2a"><b>and</b></font> <font color="#a52a2a"><b>return</b></font> <font color="#a52a2a"><b>foreach</b></font> <font color="#008b8b">@i</font>;
        <font color="#a52a2a"><b>return</b></font> <font color="#008b8b">$ipad</font>;
}

<font color="#a52a2a"><b>sub</b></font><font color="#008b8b"> </font><font color="#008b8b">in</font><font color="#008b8b"> </font>{

    <font color="#a52a2a"><b>defined</b></font> (<font color="#a52a2a"><b>my</b></font> <font color="#008b8b">$line</font> = &lt;&gt;) <font color="#a52a2a"><b>or</b></font> <font color="#a52a2a"><b>die</b></font> <font color="#ff00ff">&quot;</font><font color="#ff00ff">No line received!</font><font color="#ff00ff">&quot;</font>;
    <font color="#a52a2a"><b>chomp</b></font>(<font color="#008b8b">$line</font>);
    DEBUG <font color="#a52a2a"><b>and</b></font> <font color="#a52a2a"><b>print</b></font> <font color="#008b8b">STDERR</font> <font color="#ff00ff">&quot;</font><font color="#ff00ff">&gt;&gt;&gt; </font><font color="#008b8b">$line</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>;
    <font color="#a52a2a"><b>return</b></font> <font color="#008b8b">$line</font>;
}

<font color="#a52a2a"><b>sub</b></font><font color="#008b8b"> </font><font color="#008b8b">out</font><font color="#008b8b">($)</font><font color="#008b8b"> </font>{
    <font color="#a52a2a"><b>my</b></font> <font color="#008b8b">$line</font> = <font color="#a52a2a"><b>shift</b></font>;

    <font color="#a52a2a"><b>print</b></font> <font color="#ff00ff">&quot;</font><font color="#008b8b">$line</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font> <font color="#a52a2a"><b>and</b></font> DEBUG <font color="#a52a2a"><b>and</b></font> <font color="#a52a2a"><b>print</b></font> <font color="#008b8b">STDERR</font> <font color="#ff00ff">&quot;</font><font color="#ff00ff">&lt;&lt;&lt; </font><font color="#008b8b">$line</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>;
}

<font color="#a52a2a"><b>sub</b></font><font color="#008b8b"> </font><font color="#008b8b">bake_cookie</font><font color="#008b8b">(@)</font><font color="#008b8b"> </font>{

    <font color="#a52a2a"><b>for</b></font> (<font color="#008b8b">$_</font>[<font color="#ff00ff">0</font>]) {
        <font color="#a52a2a"><b>/</b></font><font color="#ff00ff">^sha1$</font><font color="#a52a2a"><b>/</b></font> <font color="#a52a2a"><b>and</b></font> <font color="#a52a2a"><b>return</b></font> sha1_hex(<font color="#a52a2a"><b>join</b></font> <font color="#ff00ff">&quot;&quot;</font> =&gt; <font color="#008b8b">@_</font>);
        <font color="#a52a2a"><b>/</b></font><font color="#ff00ff">^md5$</font><font color="#a52a2a"><b>/</b></font> <font color="#a52a2a"><b>and</b></font> <font color="#a52a2a"><b>return</b></font> md5_hex(<font color="#a52a2a"><b>join</b></font> <font color="#ff00ff">&quot;&quot;</font> =&gt; <font color="#008b8b">@_</font>);
    }
}

<font color="#a52a2a"><b>sub</b></font><font color="#008b8b"> </font><font color="#008b8b">make_challenge</font><font color="#008b8b">($)</font><font color="#008b8b"> </font>{ <font color="#ff00ff">&quot;</font><font color="#ff00ff">CHA=</font><font color="#ff00ff">&quot;</font> . <font color="#a52a2a"><b>shift</b></font> }

<font color="#a52a2a"><b>sub</b></font><font color="#008b8b"> </font><font color="#008b8b">make_response_template</font><font color="#008b8b">($)</font><font color="#008b8b"> </font>{
    <font color="#ff00ff">&quot;</font><font color="#ff00ff">RES=</font><font color="#ff00ff">&quot;</font> . <font color="#a52a2a"><b>join</b></font> <font color="#ff00ff">&quot;</font><font color="#ff00ff">,</font><font color="#ff00ff">&quot;</font> =&gt; <font color="#a52a2a"><b>map</b></font> <font color="#ff00ff">&quot;</font><font color="#ff00ff">([^,]+)</font><font color="#ff00ff">&quot;</font> =&gt; <font color="#ff00ff">1</font> .. <font color="#a52a2a"><b>shift</b></font>;
}

<font color="#a52a2a"><b>sub</b></font><font color="#008b8b"> </font><font color="#008b8b">get_password</font><font color="#008b8b">($)</font><font color="#008b8b"> </font>{
    <font color="#a52a2a"><b>my</b></font> <font color="#008b8b">$site</font> = <font color="#a52a2a"><b>shift</b></font>;

    <font color="#a52a2a"><b>my</b></font> <font color="#008b8b">$db</font> = <font color="#a52a2a"><b>new</b></font> Ping::Admdb::Simple(<font color="#ff00ff">qw(</font><font color="#ff00ff">DBI:mysql:admdb dynadns</font><font color="#ff00ff">)</font>)
        <font color="#a52a2a"><b>or</b></font> <font color="#a52a2a"><b>die</b></font> <font color="#ff00ff">&quot;</font><font color="#ff00ff">Couldn't construct Ping::Admdb::Simple object: </font><font color="#ff00ff">&quot;</font>,
            <font color="#008b8b">$DBI::errstr</font>;
    <font color="#008b8b">$db</font>-&gt;AdmPas(<font color="#ff00ff">&quot;</font><font color="#008b8b">$site</font><font color="#ff00ff">.</font><font color="#008b8b">$domain</font><font color="#ff00ff">&quot;</font>);
}

<font color="#a52a2a"><b>sub</b></font><font color="#008b8b"> </font><font color="#008b8b">validate_response</font><font color="#008b8b">($$)</font><font color="#008b8b"> </font>{
    <font color="#a52a2a"><b>my</b></font> <font color="#008b8b">$line</font> = <font color="#a52a2a"><b>shift</b></font>;
    <font color="#a52a2a"><b>my</b></font> <font color="#008b8b">$c_cookie</font> = <font color="#a52a2a"><b>shift</b></font>;

    <font color="#a52a2a"><b>my</b></font> <font color="#008b8b">$template</font> = make_response_template(<font color="#ff00ff">4</font>);
    <font color="#a52a2a"><b>my</b></font> (<font color="#008b8b">$type</font>, <font color="#008b8b">$r_cookie</font>, <font color="#008b8b">$site</font>, <font color="#008b8b">$ipad</font>) = <font color="#008b8b">$line</font> =~<font color="#a52a2a"><b> /</b></font><font color="#ff00ff">^</font><font color="#008b8b">$template</font><font color="#ff00ff">$</font><font color="#a52a2a"><b>/</b></font>
        <font color="#a52a2a"><b>or</b></font> <font color="#a52a2a"><b>return</b></font> <font color="#a52a2a"><b>undef</b></font>, <font color="#ff00ff">'</font><font color="#ff00ff">(unknown)</font><font color="#ff00ff">'</font>, <font color="#ff00ff">'</font><font color="#ff00ff">(unknown)</font><font color="#ff00ff">'</font>;
    <font color="#a52a2a"><b>my</b></font> <font color="#008b8b">$pass</font> = get_password(<font color="#008b8b">$site</font>) <font color="#a52a2a"><b>or</b></font> <font color="#a52a2a"><b>return</b></font> <font color="#a52a2a"><b>undef</b></font>, <font color="#008b8b">$site</font>, <font color="#008b8b">$ipad</font>;
    <font color="#a52a2a"><b>return</b></font> <font color="#008b8b">$r_cookie</font> <font color="#a52a2a"><b>eq</b></font> bake_cookie(<font color="#008b8b">$type</font>, <font color="#008b8b">$site</font>, <font color="#008b8b">$pass</font>, <font color="#008b8b">$c_cookie</font>, <font color="#008b8b">$ipad</font>),
        <font color="#008b8b">$site</font>, <font color="#008b8b">$ipad</font>;
}

<font color="#a52a2a"><b>sub</b></font><font color="#008b8b"> </font><font color="#008b8b">iso_datetime</font><font color="#008b8b"> </font>{

    <font color="#a52a2a"><b>my</b></font> <font color="#008b8b">@l</font> = <font color="#a52a2a"><b>localtime</b></font>;
    <font color="#008b8b">$l</font>[<font color="#ff00ff">5</font>] += <font color="#ff00ff">1900</font>;
    <font color="#008b8b">$l</font>[<font color="#ff00ff">4</font>] += <font color="#ff00ff">1</font>;
    <font color="#a52a2a"><b>sprintf</b></font> <font color="#ff00ff">&quot;</font><font color="#ff00ff">%04d-%02d-%02d %02d:%02d:%02d</font><font color="#ff00ff">&quot;</font> =&gt; <font color="#008b8b">@l</font>[<font color="#ff00ff">5</font>, <font color="#ff00ff">4</font>, <font color="#ff00ff">3</font>, <font color="#ff00ff">2</font>, <font color="#ff00ff">1</font>, <font color="#ff00ff">0</font>];
}

<font color="#a52a2a"><b>sub</b></font><font color="#008b8b"> </font><font color="#008b8b">dbg</font><font color="#008b8b">(@)</font><font color="#008b8b"> </font>{
    <font color="#a52a2a"><b>join</b></font> <font color="#ff00ff">&quot;&quot;</font> =&gt; iso_datetime, <font color="#ff00ff">'</font><font color="#ff00ff">@</font><font color="#ff00ff">'</font>, <font color="#008b8b">$ENV</font>{TCPREMOTEIP} || <font color="#ff00ff">&quot;</font><font color="#ff00ff">(unknown)</font><font color="#ff00ff">&quot;</font>, <font color="#ff00ff">&quot;</font><font color="#ff00ff">: </font><font color="#ff00ff">&quot;</font>, <font color="#008b8b">@_</font>;
}

<font color="#a52a2a"><b>sub</b></font><font color="#008b8b"> </font><font color="#008b8b">die_callback</font><font color="#008b8b"> </font>{ <font color="#a52a2a"><b>die</b></font> dbg(<font color="#008b8b">@_</font>) }
    <font color="#0000ff"># vim: set cin sw=4 ts=4:</font>
</pre>
</body>
</html>
