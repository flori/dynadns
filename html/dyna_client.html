<html>
<head>
<title>~/dynadns/dyna_client.html</title>
<meta name="Generator" content="Vim/6.0">
</head>
<body bgcolor="#ffffff" text="#000000">
<pre>
<font color="#a020f0">#!/usr/bin/perl -w</font>
<font color="#0000ff">#</font>
<font color="#0000ff">## $Id$</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># This program is Open Source software. It may be distributed under the</font>
<font color="#0000ff"># terms of the GNU General Public License:</font>
<font color="#0000ff">#                               http://www.gnu.org/copyleft/gpl.html</font>
<font color="#0000ff">#</font>
<font color="#0000ff">## Report bugs to &lt;flori@ping.de&gt;.</font>
<font color="#0000ff">#</font>

<font color="#a52a2a"><b>use strict</b></font>;
<font color="#a52a2a"><b>use </b></font>Digest::SHA1 <font color="#ff00ff">qw(</font><font color="#ff00ff">sha1_hex</font><font color="#ff00ff">)</font>;
<font color="#a52a2a"><b>use </b></font>Digest::MD5 <font color="#ff00ff">qw(</font><font color="#ff00ff">md5_hex</font><font color="#ff00ff">)</font>;
<font color="#a52a2a"><b>use </b></font>File::Basename;
<font color="#a52a2a"><b>use </b></font>IO::Socket;
<font color="#a52a2a"><b>use </b></font>constant <font color="#ff00ff">DEBUG </font>=&gt; <font color="#ff00ff">1</font>;

<font color="#a52a2a"><b>sub</b></font><font color="#008b8b"> </font><font color="#008b8b">in</font><font color="#008b8b">($)</font>;
<font color="#a52a2a"><b>sub</b></font><font color="#008b8b"> </font><font color="#008b8b">out</font><font color="#008b8b">($$)</font>;
<font color="#a52a2a"><b>sub</b></font><font color="#008b8b"> </font><font color="#008b8b">bake_cookie</font><font color="#008b8b">(@)</font>;
<font color="#a52a2a"><b>sub</b></font><font color="#008b8b"> </font><font color="#008b8b">make_response_string</font><font color="#008b8b">(@)</font>;
<font color="#a52a2a"><b>sub</b></font><font color="#008b8b"> </font><font color="#008b8b">make_response</font><font color="#008b8b">($$$$$)</font>;
<font color="#a52a2a"><b>sub</b></font><font color="#008b8b"> </font><font color="#008b8b">usage</font>;
<font color="#a52a2a"><b>sub</b></font><font color="#008b8b"> </font><font color="#008b8b">is_ipad</font><font color="#008b8b">($)</font>;

<font color="#a52a2a"><b>my</b></font> <font color="#008b8b">@err</font>;
<font color="#a52a2a"><b>my</b></font> <font color="#008b8b">$site</font> = <font color="#a52a2a"><b>shift</b></font> <font color="#a52a2a"><b>or</b></font> <font color="#a52a2a"><b>push</b></font> <font color="#008b8b">@err</font>, <font color="#ff00ff">&quot;</font><font color="#ff00ff">Need a sitename as first argument!</font><font color="#ff00ff">&quot;</font>;
<font color="#008b8b">$site</font> =~ <font color="#a52a2a"><b>s/</b></font><font color="#6a5acd">\.</font><font color="#ff00ff">ping</font><font color="#6a5acd">\.</font><font color="#ff00ff">de$</font><font color="#a52a2a"><b>//</b></font>;
<font color="#a52a2a"><b>my</b></font> <font color="#008b8b">$pass</font> = <font color="#a52a2a"><b>shift</b></font> <font color="#a52a2a"><b>or</b></font> <font color="#a52a2a"><b>push</b></font> <font color="#008b8b">@err</font>, <font color="#ff00ff">&quot;</font><font color="#ff00ff">Need a password as second argument!</font><font color="#ff00ff">&quot;</font>;
<font color="#a52a2a"><b>my</b></font> <font color="#008b8b">$ipad</font> = <font color="#a52a2a"><b>shift</b></font> <font color="#a52a2a"><b>or</b></font> <font color="#a52a2a"><b>push</b></font> <font color="#008b8b">@err</font>, <font color="#ff00ff">&quot;</font><font color="#ff00ff">Need an ip address or 'local' as third argument!</font><font color="#ff00ff">&quot;</font>;
<font color="#a52a2a"><b>my</b></font> <font color="#008b8b">$sprt</font> = <font color="#a52a2a"><b>shift</b></font> || <font color="#ff00ff">&quot;</font><font color="#ff00ff">lilly.ping.de:5353</font><font color="#ff00ff">&quot;</font>;
<font color="#a52a2a"><b>my</b></font> <font color="#008b8b">$type</font> = <font color="#a52a2a"><b>shift</b></font> || <font color="#ff00ff">&quot;</font><font color="#ff00ff">sha1</font><font color="#ff00ff">&quot;</font>;
bake_cookie(<font color="#008b8b">$type</font>) <font color="#a52a2a"><b>or</b></font> <font color="#a52a2a"><b>push</b></font> <font color="#008b8b">@err</font>, <font color="#ff00ff">&quot;</font><font color="#ff00ff">Invalid type of hash: '</font><font color="#008b8b">$type</font><font color="#ff00ff">'!</font><font color="#ff00ff">&quot;</font>;

usage(<font color="#008b8b">@err</font>) <font color="#a52a2a"><b>if</b></font> <font color="#008b8b">@err</font>;

{
    <font color="#a52a2a"><b>my</b></font> <font color="#008b8b">$s</font>;
    <font color="#a52a2a"><b>if</b></font> (<font color="#008b8b">$ipad</font> <font color="#a52a2a"><b>ne</b></font> <font color="#ff00ff">&quot;</font><font color="#ff00ff">local</font><font color="#ff00ff">&quot;</font>) {
        is_ipad(<font color="#008b8b">$ipad</font>) <font color="#a52a2a"><b>or</b></font> <font color="#a52a2a"><b>die</b></font> <font color="#ff00ff">&quot;</font><font color="#ff00ff">IP address '</font><font color="#008b8b">$ipad</font><font color="#ff00ff">' not valid!</font><font color="#ff00ff">&quot;</font>;
    }
    <font color="#008b8b">$s</font> = <font color="#a52a2a"><b>new</b></font> IO::Socket::INET(<font color="#008b8b">$sprt</font>) <font color="#a52a2a"><b>or</b></font> <font color="#a52a2a"><b>die</b></font> <font color="#ff00ff">&quot;</font><font color="#ff00ff">Couldn't connect '</font><font color="#008b8b">$sprt</font><font color="#ff00ff">'!</font><font color="#ff00ff">&quot;</font>
        <font color="#a52a2a"><b>unless</b></font> DEBUG &gt; <font color="#ff00ff">1</font>;
    <font color="#a52a2a"><b>my</b></font> <font color="#008b8b">$line</font> = in(<font color="#008b8b">$s</font>);
    out(<font color="#008b8b">$s</font>, make_response(<font color="#008b8b">$type</font>, <font color="#008b8b">$site</font>, <font color="#008b8b">$pass</font>, <font color="#008b8b">$line</font>, <font color="#008b8b">$ipad</font>));
    <font color="#008b8b">$line</font> = in(<font color="#008b8b">$s</font>);
    <font color="#a52a2a"><b>exit</b></font> (<font color="#008b8b">$line</font> <font color="#a52a2a"><b>eq</b></font> <font color="#ff00ff">&quot;</font><font color="#ff00ff">ACK</font><font color="#ff00ff">&quot;</font> ? <font color="#ff00ff">0</font> : <font color="#ff00ff">1</font>);
}

<font color="#a52a2a"><b>sub</b></font><font color="#008b8b"> </font><font color="#008b8b">is_ipad</font><font color="#008b8b">($)</font><font color="#008b8b"> </font>{
        <font color="#a52a2a"><b>my</b></font> <font color="#008b8b">$ipad</font> = <font color="#a52a2a"><b>shift</b></font> <font color="#a52a2a"><b>or</b></font> <font color="#a52a2a"><b>return</b></font>;

        <font color="#a52a2a"><b>my</b></font> <font color="#008b8b">@i</font> = <font color="#008b8b">$ipad</font> =~<font color="#a52a2a"><b> /</b></font><font color="#ff00ff">^</font><font color="#6a5acd">(</font><font color="#6a5acd">\d</font><font color="#6a5acd">+)</font><font color="#6a5acd">\.</font><font color="#6a5acd">(</font><font color="#6a5acd">\d</font><font color="#6a5acd">+)</font><font color="#6a5acd">\.</font><font color="#6a5acd">(</font><font color="#6a5acd">\d</font><font color="#6a5acd">+)</font><font color="#6a5acd">\.</font><font color="#6a5acd">(</font><font color="#6a5acd">\d</font><font color="#6a5acd">+)</font><font color="#ff00ff">$</font><font color="#a52a2a"><b>/</b></font> <font color="#a52a2a"><b>or</b></font> <font color="#a52a2a"><b>return</b></font>;
        <font color="#008b8b">$_</font> &gt; <font color="#ff00ff">255</font> <font color="#a52a2a"><b>and</b></font> <font color="#a52a2a"><b>return</b></font> <font color="#a52a2a"><b>foreach</b></font> <font color="#008b8b">@i</font>;
        <font color="#a52a2a"><b>return</b></font> <font color="#008b8b">$ipad</font>;
}

<font color="#a52a2a"><b>sub</b></font><font color="#008b8b"> </font><font color="#008b8b">in</font><font color="#008b8b">($)</font><font color="#008b8b"> </font>{
    <font color="#a52a2a"><b>my</b></font> <font color="#008b8b">$s</font> = <font color="#a52a2a"><b>shift</b></font>;

    <font color="#008b8b">$s</font> = \*STDIN <font color="#a52a2a"><b>if</b></font> DEBUG &gt; <font color="#ff00ff">1</font>;
    <font color="#a52a2a"><b>defined</b></font> (<font color="#a52a2a"><b>my</b></font> <font color="#008b8b">$line</font> = &lt;<font color="#008b8b">$s</font>&gt;) <font color="#a52a2a"><b>or</b></font> <font color="#a52a2a"><b>die</b></font> <font color="#ff00ff">&quot;</font><font color="#ff00ff">No line received!</font><font color="#ff00ff">&quot;</font>;
    <font color="#a52a2a"><b>chomp</b></font>(<font color="#008b8b">$line</font>);
    DEBUG <font color="#a52a2a"><b>and</b></font> <font color="#a52a2a"><b>print</b></font> <font color="#008b8b">STDERR</font> <font color="#ff00ff">&quot;</font><font color="#ff00ff">&gt;&gt;&gt; </font><font color="#008b8b">$line</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>;
    <font color="#a52a2a"><b>return</b></font> <font color="#008b8b">$line</font>;
}

<font color="#a52a2a"><b>sub</b></font><font color="#008b8b"> </font><font color="#008b8b">out</font><font color="#008b8b">($$)</font><font color="#008b8b"> </font>{
    <font color="#a52a2a"><b>my</b></font> <font color="#008b8b">$s</font> = <font color="#a52a2a"><b>shift</b></font>;
    <font color="#a52a2a"><b>my</b></font> <font color="#008b8b">$line</font> = <font color="#a52a2a"><b>shift</b></font>;

    <font color="#008b8b">$s</font> = \*STDOUT <font color="#a52a2a"><b>if</b></font> DEBUG &gt; <font color="#ff00ff">1</font>;
    <font color="#a52a2a"><b>print</b></font> <font color="#008b8b">$s</font> <font color="#ff00ff">&quot;</font><font color="#008b8b">$line</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font> <font color="#a52a2a"><b>and</b></font> DEBUG <font color="#a52a2a"><b>and</b></font> <font color="#a52a2a"><b>print</b></font> <font color="#008b8b">STDERR</font> <font color="#ff00ff">&quot;</font><font color="#ff00ff">&lt;&lt;&lt; </font><font color="#008b8b">$line</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font>;
}

<font color="#a52a2a"><b>sub</b></font><font color="#008b8b"> </font><font color="#008b8b">bake_cookie</font><font color="#008b8b">(@)</font><font color="#008b8b"> </font>{

    <font color="#a52a2a"><b>for</b></font> (<font color="#008b8b">$_</font>[<font color="#ff00ff">0</font>]) {
        <font color="#a52a2a"><b>/</b></font><font color="#ff00ff">^sha1$</font><font color="#a52a2a"><b>/</b></font> <font color="#a52a2a"><b>and</b></font> <font color="#a52a2a"><b>return</b></font> sha1_hex(<font color="#a52a2a"><b>join</b></font> <font color="#ff00ff">&quot;&quot;</font> =&gt; <font color="#008b8b">@_</font>);
        <font color="#a52a2a"><b>/</b></font><font color="#ff00ff">^md5$</font><font color="#a52a2a"><b>/</b></font> <font color="#a52a2a"><b>and</b></font> <font color="#a52a2a"><b>return</b></font> md5_hex(<font color="#a52a2a"><b>join</b></font> <font color="#ff00ff">&quot;&quot;</font> =&gt; <font color="#008b8b">@_</font>);
    }
}

<font color="#a52a2a"><b>sub</b></font><font color="#008b8b"> </font><font color="#008b8b">make_response_string</font><font color="#008b8b">(@)</font><font color="#008b8b"> </font>{ <font color="#ff00ff">&quot;</font><font color="#ff00ff">RES=</font><font color="#ff00ff">&quot;</font> . <font color="#a52a2a"><b>join</b></font> <font color="#ff00ff">&quot;</font><font color="#ff00ff">,</font><font color="#ff00ff">&quot;</font> =&gt; <font color="#008b8b">@_</font> }

<font color="#a52a2a"><b>sub</b></font><font color="#008b8b"> </font><font color="#008b8b">make_response</font><font color="#008b8b">($$$$$)</font><font color="#008b8b"> </font>{
    <font color="#a52a2a"><b>my</b></font> <font color="#008b8b">$type</font> = <font color="#a52a2a"><b>shift</b></font>;
    <font color="#a52a2a"><b>my</b></font> <font color="#008b8b">$site</font> = <font color="#a52a2a"><b>shift</b></font>;
    <font color="#a52a2a"><b>my</b></font> <font color="#008b8b">$pass</font> = <font color="#a52a2a"><b>shift</b></font>;
    <font color="#a52a2a"><b>my</b></font> <font color="#008b8b">$line</font> = <font color="#a52a2a"><b>shift</b></font>;
    <font color="#a52a2a"><b>my</b></font> <font color="#008b8b">$ipad</font> = <font color="#a52a2a"><b>shift</b></font>;

    <font color="#a52a2a"><b>my</b></font> <font color="#008b8b">$c_cookie</font>;
    (<font color="#008b8b">$c_cookie</font>) = <font color="#008b8b">$line</font> =~<font color="#a52a2a"><b> /</b></font><font color="#ff00ff">^CHA=</font><font color="#6a5acd">(.+)</font><font color="#ff00ff">$</font><font color="#a52a2a"><b>/</b></font>
        <font color="#a52a2a"><b>or</b></font> <font color="#a52a2a"><b>die</b></font> <font color="#ff00ff">&quot;</font><font color="#ff00ff">Format of challenge '</font><font color="#008b8b">$line</font><font color="#ff00ff">' not 'CHA=COOKIE'!</font><font color="#ff00ff">&quot;</font>;
    make_response_string(<font color="#008b8b">$type</font>,
        bake_cookie(<font color="#008b8b">$type</font>, <font color="#008b8b">$site</font>, <font color="#008b8b">$pass</font>, <font color="#008b8b">$c_cookie</font>, <font color="#008b8b">$ipad</font>), <font color="#008b8b">$site</font>, <font color="#008b8b">$ipad</font>);
}

<font color="#a52a2a"><b>sub</b></font><font color="#008b8b"> </font><font color="#008b8b">usage</font><font color="#008b8b"> </font>{
    <font color="#a52a2a"><b>my</b></font> <font color="#008b8b">@usage</font> = <font color="#008b8b">@_</font>;

    <font color="#a52a2a"><b>my</b></font> <font color="#008b8b">$basename</font> = basename <font color="#008b8b">$0</font>;
    <font color="#008b8b">$site</font> ||= <font color="#ff00ff">&quot;</font><font color="#ff00ff">undef</font><font color="#ff00ff">&quot;</font>;
    <font color="#008b8b">$ipad</font> ||= <font color="#ff00ff">&quot;</font><font color="#ff00ff">undef</font><font color="#ff00ff">&quot;</font>;
    <font color="#a52a2a"><b>push</b></font> <font color="#008b8b">@usage</font>, <font color="#ff00ff">&lt;&lt;&quot;__USAGE&quot;</font><font color="#ff00ff">;</font>

<font color="#ff00ff">Usage: </font><font color="#008b8b">$basename</font><font color="#ff00ff"> SITENAME PASSWORD IPADDR|local [SERVER:PORT] [HASHTYPE]</font>

<font color="#ff00ff">  SITENAME       = your sitename without domain (</font><font color="#008b8b">$site</font><font color="#ff00ff">)</font>
<font color="#ff00ff">  PASSWORD       = your admin password (***secret***)</font>
<font color="#ff00ff">  IPADDR/local  = the dynamic IP address or 'local' for the local ip (</font><font color="#008b8b">$ipad</font><font color="#ff00ff">)</font>
<font color="#ff00ff">                   0.0.0.0 zaps the old dns entry for SITENAME</font>
<font color="#ff00ff">  SERVER:PORT    = dynadns server and port to connect to (</font><font color="#008b8b">$sprt</font><font color="#ff00ff">)</font>
<font color="#ff00ff">  HASHTYPE       = md5 | sha1 (</font><font color="#008b8b">$type</font><font color="#ff00ff">)</font>

<font color="#ff00ff">Report bugs to &lt;flori</font><font color="#6a5acd">\@</font><font color="#ff00ff">ping.de&gt;.</font>
<font color="#ff00ff">__USAGE</font>

    <font color="#a52a2a"><b>die</b></font> <font color="#a52a2a"><b>join</b></font> <font color="#ff00ff">&quot;</font><font color="#6a5acd">\n</font><font color="#ff00ff">&quot;</font> =&gt; <font color="#008b8b">@usage</font>;
}
    <font color="#0000ff"># vim: set cin sw=4 ts=4:</font>
</pre>
</body>
</html>
